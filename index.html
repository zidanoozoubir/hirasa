<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>نظام توزيع الحراسة</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"
            onload="console.log('SheetJS loaded successfully')"
            onerror="alert('⚠️ فشل تحميل مكتبة SheetJS. تحقق من الاتصال بالإنترنت أو أعد المحاولة لاحقاً.')"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: #f4f4f4;
            padding: 20px;
            color: #333;
            line-height: 1.6;
        }
        h2, h3 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .controls {
            text-align: center;
            margin-bottom: 30px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
        }
        .input-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 10px;
        }
        .input-group label {
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
            text-align: center;
            font-size: 15px;
        }
        .controls input[type="file"],
        .controls input[type="number"],
        .controls select {
            padding: 10px 12px;
            font-size: 16px;
            border-radius: 8px;
            border: 1px solid #c0c0c0;
            transition: all 0.3s ease;
            cursor: pointer;
            width: auto;
            min-width: 100px;
        }
        .controls button {
            padding: 12px 20px;
            font-size: 17px;
            margin: 10px;
            border-radius: 25px;
            border: none;
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            min-width: 150px;
        }
        .controls button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        .controls button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .controls button:disabled {
            cursor: not-allowed;
            opacity: 0.5;
            background: #cccccc !important;
        }
        .controls button#randomAssignBtn {
            background: linear-gradient(to right, #6dd5ed, #2193b0);
        }
        .controls button#saveDistributionBtn {
            background: linear-gradient(to right, #4CAF50, #81C784);
        }
        .controls button#generateListBtn {
            background: linear-gradient(to right, #FFC107, #FFD54F);
        }
        .controls button#exportDistributionBtn {
            background: linear-gradient(to right, #9C27B0, #BA68C8);
        }
        .controls button#clearCacheBtn {
            background: linear-gradient(to right, #795548, #A1887F);
        }
        /* New button style for Reset Distribution */
        .controls button#resetDistributionBtn {
            background: linear-gradient(to right, #e67e22, #f39c12); /* Orange */
        }

        /* --- New Styles for Filter Controls --- */
        .filter-controls {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
        }
        .search-group, .filter-group {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .search-group label, .filter-group label {
            font-weight: bold;
            color: #555;
            white-space: nowrap;
        }
        .filter-controls input[type="text"] {
            padding: 10px;
            font-size: 16px;
            border-radius: 8px;
            border: 1px solid #c0c0c0;
            width: 250px;
            transition: all 0.3s ease;
        }
        .filter-controls select {
            padding: 10px;
            font-size: 16px;
            border-radius: 8px;
            border: 1px solid #c0c0c0;
            cursor: pointer;
            min-width: 150px;
            transition: all 0.3s ease;
        }
        .filter-controls button {
            padding: 10px 15px;
            font-size: 16px;
            border-radius: 20px;
            border: none;
            color: white;
            cursor: pointer;
            background: linear-gradient(to right, #f39c12, #f1c40f);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        .filter-controls button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        /* --- End New Styles --- */

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-top: 20px;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #e0e0e0;
        }
        th, td {
            border: 1px solid #eee;
            padding: 15px;
            text-align: center;
            vertical-align: middle;
            font-size: 15px;
        }
        th {
            background: #4a90e2;
            color: white;
            font-weight: bold;
            border-color: #4a90e2;
        }
        tr:nth-child(even) { background-color: #f6faff; }
        tr:hover { background-color: #eaf3ff; }

        .fixed-guard-row {
            background-color: #ffe0b2 !important;
            font-weight: bold;
            color: #6d4c41;
        }
        /* Removed specific disabled styles for fixed-guard-row inputs as they are now editable */
        /* .fixed-guard-row input[type="text"],
        .fixed-guard-row input[type="checkbox"],
        .fixed-guard-row .reserve-select {
            cursor: not-allowed;
            opacity: 0.7;
        } */

        .main-guard-row {
            background-color: #2196F3 !important;
            color: #FFFFFF;
        }

        .exempt-guard-row {
            background-color: #f7f7f7 !important;
            color: #888;
            text-decoration: line-through;
            opacity: 0.7;
        }
        .exempt-guard-row input:not([type="checkbox"]),
        .exempt-guard-row .reserve-select {
            opacity: 0.5;
            background-color: #f0f0f0;
        }
        .exempt-guard-row input[type="checkbox"] {
            cursor: not-allowed;
        }
        .exempt-guard-row .btn-danger {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .reserve-guard-row {
            background-color: #4CAF50 !important;
            color: #FFFFFF;
            font-style: italic;
        }
        .reserve-guard-row input:not([type="checkbox"]),
        .reserve-guard-row .reserve-select {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #f0f0f0;
        }
        .reserve-guard-row input[type="checkbox"] {
            cursor: not-allowed;
        }
        .reserve-guard-row .btn-danger {
            opacity: 0.5;
            cursor: not-allowed;
        }

        input[type="text"], input[type="number"] {
            width: 100px;
            padding: 8px;
            text-align: center;
            border: 1px solid #a0a0a0;
            border-radius: 6px;
            font-size: 15px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        input[type="text"]:focus, input[type="number"]:focus,
        .controls input[type="file"]:focus,
        .controls select:focus,
        .controls button:focus,
        .filter-controls input[type="text"]:focus,
        .filter-controls select:focus,
        .filter-controls button:focus {
            outline: none;
            border-color: #2193b0;
            box-shadow: 0 0 0 3px rgba(33, 147, 176, 0.3);
        }
        input[type="checkbox"] {
            transform: scale(1.3);
            margin: 0 5px;
            cursor: pointer;
        }
        .btn-danger {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
            transition: background 0.3s ease;
        }
        .btn-danger:hover { background: #c0392b; }

        #printBtn {
            display: none;
            margin: 30px auto;
            padding: 15px 30px;
            font-size: 19px;
            background: linear-gradient(to right, #4facfe, #00f2fe);
            border: none;
            border-radius: 30px;
            color: white;
            cursor: pointer;
            box-shadow: 0 5px 10px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        #printBtn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(0 0 0 / 0.25);
        }
        #statusMessage {
            text-align: center;
            padding: 12px;
            margin: 10px auto 20px auto;
            border-radius: 8px;
            font-weight: bold;
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease;
            max-width: 600px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .status-success { background-color: #e6ffed; color: #388e3c; border: 1px solid #a5d6a7; }
        .status-error { background-color: #ffebee; color: #d32f2f; border: 1px solid #ef9a9a; }
        .status-info { background-color: #e3f2fd; color: #1976d2; border: 1px solid #90caf9; }
        .status-loading { background-color: #fffde7; color: #fbc02d; border: 1px solid #fff9c4; }

        .reserve-select {
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #a0a0a0;
            font-size: 15px;
            width: 120px;
            text-align: center;
            appearance: none;
            background-color: white;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20256%20256%22%3E%3Cpath%20fill%3D%22%23666%22%20d%3D%22M128%2C186.2L32%2C90.2h192z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .reserve-select:focus {
            outline: none;
            border-color: #2193b0;
            box-shadow: 0 0 0 3px rgba(33, 147, 176, 0.3);
        }

        .reserve-select:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background-color: #f0f0f0;
        }
        .reserve-select-cell {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
        }

        /* New Guard Addition Section Styles */
        .add-guard-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-top: 30px;
            text-align: center;
        }
        .add-guard-section h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #4a90e2;
            border-bottom: none;
        }
        .add-guard-inputs {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
        }
        .add-guard-inputs input[type="text"] {
            padding: 10px 12px;
            font-size: 16px;
            border-radius: 8px;
            border: 1px solid #c0c0c0;
            width: 200px;
            max-width: 100%;
        }
        .add-guard-inputs button {
            padding: 12px 20px;
            font-size: 17px;
            border-radius: 25px;
            border: none;
            color: white;
            cursor: pointer;
            background: linear-gradient(to right, #00C9FF, #92FE9D);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        .add-guard-inputs button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            .input-group, .button-group {
                margin: 0;
                width: 100%;
            }
            .controls button {
                width: 100%;
                margin: 10px 0;
            }
            /* Responsive for filter controls */
            .filter-controls {
                flex-direction: column;
                align-items: stretch;
            }
            .search-group, .filter-group {
                flex-direction: column;
                align-items: stretch;
            }
            .filter-controls input[type="text"],
            .filter-controls select,
            .filter-controls button {
                width: 100%;
                margin: 5px 0;
            }

            table, th, td {
                font-size: 14px;
                padding: 10px;
            }
            input[type="text"], input[type="number"], .reserve-select {
                width: 80px;
            }
        }

        /* Print Specific Styles */
        @media print {
            html, body {
                width: 100%;
                margin: 0;
                padding: 0;
            }
            body {
                background: none;
                padding: 1cm; /* Adjust overall padding for print */
                margin: 0;
                color: black;
                font-size: 11pt; /* Slightly smaller base font for more content */
            }
            .controls, .filter-controls, .add-guard-section, #statusMessage, #printBtn {
                display: none; /* Hide UI elements not relevant for print */
            }
            h2, h3 {
                border-bottom: none;
                margin-top: 20px;
                margin-bottom: 10px;
                font-size: 16pt; /* Slightly smaller heading for print */
                page-break-after: avoid; /* Keep heading with table below */
                padding-bottom: 0; /* Remove underline for print */
            }
            #guardsTable, #finalGuardsTable, #reserveGuardsTable {
                box-shadow: none;
                padding: 0;
                margin-top: 0;
                overflow: visible; /* Allow content to overflow if necessary, handled by page-break */
            }
            table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 10px;
                margin-bottom: 20px; /* Space between tables */
                border: 1px solid #aaa; /* Clearer table borders */
            }
            th, td {
                border: 1px solid #ccc;
                padding: 6px 8px; /* Reduced padding for more content */
                text-align: right;
                font-size: 9pt; /* Smaller font for table cells */
            }
            th {
                background-color: #e0e0e0; /* Light background for headers */
                color: #333;
                font-weight: bold;
            }
            tr {
                page-break-inside: avoid; /* Keep table rows together */
            }
            /* Ensure background colors are transparent for print */
            .fixed-guard-row, .main-guard-row, .exempt-guard-row, .reserve-guard-row {
                background-color: transparent !important;
                color: black !important;
                text-decoration: none !important;
                font-weight: normal !important; /* Reset font weight for clarity */
                font-style: normal !important; /* Reset font style */
            }
            /* Remove explicit page-break-after for main table, allow natural flow */
            #finalGuardsTable {
                margin-bottom: 30px; /* Space after the main table */
            }
            #reserveGuardsTable {
                margin-top: 20px; /* Space before reserve table */
            }
        }
    </style>
</head>
<body>

<h2>📋 نظام توزيع الحراسة - استيراد وتوزيع</h2>
<div id="statusMessage"></div>
<div class="controls">
    <div class="input-group">
        <label for="excelFile">استيراد ملف Excel</label>
        <input type="file" id="excelFile" accept=".xlsx,.xls" />
    </div>

    <div class="input-group">
        <label for="roomCount">عدد القاعات</label>
        <input type="number" id="roomCount" value="5" min="1" />
    </div>

    <div class="input-group">
        <label for="guardsPerRoom">عدد الحراس في قاعة</label>
        <input type="number" id="guardsPerRoom" value="3" min="1" />
    </div>

    <div class="input-group">
        <label for="periodSelect">الفترة</label>
        <select id="periodSelect"></select>
    </div>

    <div class="button-group">
        <button id="randomAssignBtn">🔀 توزيع عشوائي</button>
        <button id="resetDistributionBtn">↩️ إعادة ضبط التوزيع</button>
        <button id="saveDistributionBtn">📂 حفظ التوزيع</button>
        <button id="generateListBtn">📋 إنجاز القائمة</button>
        <button id="exportDistributionBtn">📤 تصدير التوزيع</button>
        <button id="clearCacheBtn">🗑️ مسح الذاكرة المحلية</button>
    </div>
</div>

<div class="filter-controls">
    <div class="search-group">
        <label for="searchGuardInput">بحث بالاسم أو المادة:</label>
        <input type="text" id="searchGuardInput" placeholder="اكتب للبحث..." />
        <button id="clearSearchBtn">مسح البحث</button>
    </div>
    <div class="filter-group">
        <label for="filterRank">الرتبة:</label>
        <select id="filterRank">
            <option value="">الكل</option>
        </select>
        <label for="filterSubject">المادة:</label>
        <select id="filterSubject">
            <option value="">الكل</option>
        </select>
        <label for="filterInstitution">المؤسسة:</label>
        <select id="filterInstitution">
            <option value="">الكل</option>
        </select>
    </div>
</div>
<table id="guardsTable">
    <thead>
    <tr>
        <th>الرقم</th>
        <th>الاسم واللقب</th>
        <th>المادة</th>
        <th>الرتبة</th>
        <th>المؤسسة</th>
        <th>رقم القاعة</th>
        <th>رئيسي</th>
        <th>تثبيت</th>
        <th>معفى</th>
        <th>احتياطي</th>
        <th>حذف</th>
    </tr>
    </thead>
    <tbody></tbody>
</table>

<div class="add-guard-section">
    <h3>➕ إضافة حارس جديد يدوياً:</h3>
    <div class="add-guard-inputs">
        <input type="text" id="newGuardName" placeholder="الاسم واللقب" required>
        <input type="text" id="newGuardSubject" placeholder="المادة" required>
        <input type="text" id="newGuardRank" placeholder="الرتبة">
        <input type="text" id="newGuardInstitution" placeholder="المؤسسة">
        <button id="addGuardBtn">إضافة حارس</button>
    </div>
</div>

<h3>✅ قائمة الحراسة النهائية:</h3>
<table id="finalGuardsTable"></table>

<h3>⚠️ الحراس الاحتياطيون:</h3>
<table id="reserveGuardsTable"></table>

<button id="printBtn" onclick="printTable()">🚶️ طباعة القائمة</button>

<script>
    const IDS = {
        EXCEL_FILE: "excelFile",
        ROOM_COUNT: "roomCount",
        GUARDS_PER_ROOM: "guardsPerRoom",
        PERIOD_SELECT: "periodSelect",
        RANDOM_ASSIGN_BTN: "randomAssignBtn",
        SAVE_DISTRIBUTION_BTN: "saveDistributionBtn",
        GENERATE_LIST_BTN: "generateListBtn",
        EXPORT_DISTRIBUTION_BTN: "exportDistributionBtn",
        GUARDS_TABLE: "guardsTable",
        FINAL_GUARDS_TABLE: "finalGuardsTable",
        RESERVE_GUARDS_TABLE: "reserveGuardsTable",
        PRINT_BTN: "printBtn",
        STATUS_MESSAGE: "statusMessage",
        CLEAR_CACHE_BTN: "clearCacheBtn",
        // New IDs for filters
        SEARCH_GUARD_INPUT: "searchGuardInput",
        CLEAR_SEARCH_BTN: "clearSearchBtn",
        FILTER_RANK: "filterRank",
        FILTER_SUBJECT: "filterSubject",
        FILTER_INSTITUTION: "filterInstitution",
        // New ID for reset distribution
        RESET_DISTRIBUTION_BTN: "resetDistributionBtn",
        // IDs for manual guard addition (re-introduced based on earlier conversation)
        ADD_GUARD_BTN: 'addGuardBtn',
        NEW_GUARD_NAME: 'newGuardName',
        NEW_GUARD_SUBJECT: 'newGuardSubject',
        NEW_GUARD_RANK: 'newGuardRank',
        NEW_GUARD_INSTITUTION: 'newGuardInstitution',
    };

    const MESSAGES = {
        SHEETJS_LOAD_ERROR: '⚠️ مكتبة SheetJS غير متاحة. تحقق من الاتصال بالإنترنت أو أعد المحاولة لاحقاً.',
        FILE_NOT_SELECTED: '⚠️ يرجى اختيار ملف Excel.',
        EXCEL_READ_ERROR: '⚠️ حدث خطأ أثناء استيراد ملف Excel. تحقق من صيغة الملف.',
        MISSING_FIELDS: (fields) => `⚠️ ملف Excel غير صحيح. الحقول المفقودة: ${fields.join(", ")}`,
        IMPORT_SUCCESS: '✅ تم استيراد ملف Excel بنجاح',
        PERIOD_CHANGED: (period) => `✅ تم تغيير الفترة إلى ${period}`,
        ASSIGN_ERROR: '⚠️ حدث خطأ أثناء التوزيع العشوائي.',
        NOT_ENOUGH_GUARDS: (available, required) => `⚠️ عدد الحراس المتاحين (${available}) أقل من العدد المطلوب (${required}).`,
        NOT_ENOUGH_MAIN_GUARDS: (available, required) => `⚠️ عدد الحراس الرئيسيين المتاحين (${available}) أقل من العدد المطلوب (${required}) لتغطية جميع القاعات.`,
        TOO_MANY_MAIN_GUARDS_MANUAL: (roomCount) => `⚠️ لا يمكن تعيين أكثر من ${roomCount} حراس رئيسيين. يرجى إلغاء اختيار حارس رئيسي آخر أولاً.`,
        TOO_MANY_MAIN_GUARDS_IN_ROOM: (roomNumber) => `⚠️ لا يمكن تعيين حارسين رئيسيين في القاعة ${roomNumber}. يرجى إلغاء اختيار حارس رئيسي آخر من هذه القاعة.`,
        UNASSIGNED_GUARD: (name) => `⚠️ فشل في تعيين الحارس ${name} بسبب قيود التوزيع أو عدم كفاية القاعات.`,
        UNFILLED_ROOMS: (rooms) => `⚠️ القاعات التالية لم تُملأ بالكامل:\n${rooms.join("\n")}`,
        RANDOM_ASSIGN_SUCCESS: "✅ تم التوزيع العشوائي بنجاح",
        ROOM_INPUT_ERROR: "⚠️ يرجى إدخال رقم قاعة صحيح.",
        FIX_ROOM_REQUIRED: "⚠️ يرجى تحديد رقم قاعة قبل التثبيت.",
        MAIN_ROOM_REQUIRED: "⚠️ يرجى تحديد رقم قاعة للحارس قبل تعيينه كرئيسي.",
        GUARD_DELETED: (name) => `✅ تم حذف الحارس ${name}`,
        SAVE_SUCCESS: (period) => `✅ تم حفظ التوزيع بنجاح للفترة ${period}`,
        GENERATE_LIST_SUCCESS: "✅ تم إنشاء القائمة النهائية بنجاح",
        EXPORT_SUCCESS: "✅ تم تصدير التوزيع بنجاح",
        PRINT_OPEN: "✅ تم فتح نافذة الطباعة",
        GENERIC_ERROR: "⚠️ حدث خطأ غير متوقع. يرجى مراجعة سجل الأخطاء.",
        LOADING_IMPORT: "جارٍ استيراد ملف Excel...",
        LOADING_ASSIGN: "جارٍ تنفيذ التوزيع العشوائي...",
        LOADING_EXPORT: "جارٍ تصدير التوزيع...",
        LOADING_PRINT: "جارٍ إعداد صفحة الطباعة...",
        CLEAR_CACHE_CONFIRM: "هل أنت متأكد أنك تريد مسح جميع البيانات المخزنة محلياً؟ هذا سيعيد التطبيق إلى حالته الأصلية وسيتطلب إعادة تحميل ملف Excel.",
        CLEAR_CACHE_SUCCESS: "✅ تم مسح البيانات المخزنة محلياً وإعادة تحميل الصفحة بنجاح.",
        RESERVE_GUARD_ENABLED: (name) => `✅ تم جعل الحارس ${name} احتياطياً.`,
        RESERVE_GUARD_DISABLED: (name) => `✅ تم إلغاء حالة احتياطي للحارس ${name}.`,
        RESET_DISTRIBUTION_CONFIRM: "هل أنت متأكد من إعادة ضبط التوزيع الحالي؟ سيؤدي هذا إلى مسح القاعات والمعفى والاحتياطي وإعادة الحراس إلى حالتهم الأصلية لهذه الفترة، مع الحفاظ على التثبيتات.",
        RESET_DISTRIBUTION_SUCCESS: "✅ تم إعادة ضبط التوزيع الحالي بنجاح.",
        ADD_GUARD_SUCCESS: '✅ تم إضافة الحارس بنجاح.',
        ADD_GUARD_ERROR: '❌ يرجى ملء حقل الاسم واللقب والمادة لإضافة حارس.',
    };

    let allGuards = []; // Current guards for the active period
    let baseGuards = []; // Original guards loaded from Excel
    let distributions = {}; // Stores distributions for each period
    let currentPeriod = 1;
    const TOTAL_PERIODS = 11;
    // Renamed globalMainFixedMap to globalFixedAssignments for clarity
    let globalFixedAssignments = {}; // Stores fixed assignments across all periods (Name -> RoomNumber)

    let autoSaveTimer; // Declare autoSaveTimer
    const AUTO_SAVE_INTERVAL = 30 * 1000; // 30 seconds

    document.addEventListener("DOMContentLoaded", function() {
        console.log('DOM Content Loaded');
        loadSettingsFromLocalStorage();
        initializePeriodSelect();
        attachEventListeners();
        updateGuardsTable();
        populateFilterOptions(); // Populate filter options on load
        startAutoSave(); // Start auto-save
    });

    function loadSettingsFromLocalStorage() {
        try {
            const storedRoomCount = localStorage.getItem('roomCount');
            const storedGuardsPerRoom = localStorage.getItem('guardsPerRoom');
            const storedCurrentPeriod = localStorage.getItem('currentPeriod');
            // Updated to use the new variable name
            const storedFixedAssignments = localStorage.getItem('globalFixedAssignments'); 
            const storedDistributions = localStorage.getItem('distributions');
            const storedBaseGuards = localStorage.getItem('baseGuards');

            if (storedRoomCount) document.getElementById(IDS.ROOM_COUNT).value = storedRoomCount;
            if (storedGuardsPerRoom) document.getElementById(IDS.GUARDS_PER_ROOM).value = storedGuardsPerRoom;
            if (storedCurrentPeriod) currentPeriod = parseInt(storedCurrentPeriod);
            // Updated to use the new variable name
            if (storedFixedAssignments) globalFixedAssignments = JSON.parse(storedFixedAssignments); 
            if (storedDistributions) distributions = JSON.parse(storedDistributions);
            if (storedBaseGuards) baseGuards = JSON.parse(storedBaseGuards);

            if (distributions[currentPeriod]) {
                allGuards = JSON.parse(JSON.stringify(distributions[currentPeriod]));
            } else {
                allGuards = JSON.parse(JSON.stringify(baseGuards));
            }

            // Ensure fixed guards retain their properties when loading
            allGuards.forEach(g => {
                if (globalFixedAssignments[g["الاسم واللقب"]]) {
                    g["القاعة"] = globalFixedAssignments[g["الاسم واللقب"]];
                    // Do not automatically set 'رئيسي' or clear 'معفى'/'احتياطي' here
                    // The 'fixed-guard-row' class will visually indicate it's fixed.
                    // If they are fixed, they cannot be exempt or reserve at that moment.
                    if (g["معفى"]) {
                        g["معفى"] = false;
                        setStatusMessage(`تم إلغاء إعفاء الحارس ${g["الاسم واللقب"]} لأنه مثبت.`, "info", 5000);
                    }
                    if (g["احتياطي"]) {
                        g["احتياطي"] = false;
                        setStatusMessage(`تم إلغاء حالة احتياطي للحارس ${g["الاسم واللقب"]} لأنه مثبت.`, "info", 5000);
                    }
                }
            });

        } catch (error) {
            console.error("Error loading settings from local storage:", error);
            setStatusMessage("⚠️ حدث خطأ أثناء تحميل الإعدادات المحفوظة.", "error", 5000);
        }
    }

    function saveSettingsToLocalStorage() {
        try {
            localStorage.setItem('roomCount', document.getElementById(IDS.ROOM_COUNT).value);
            localStorage.setItem('guardsPerRoom', document.getElementById(IDS.GUARDS_PER_ROOM).value);
            localStorage.setItem('currentPeriod', currentPeriod);
            // Updated to use the new variable name
            localStorage.setItem('globalFixedAssignments', JSON.stringify(globalFixedAssignments)); 
            localStorage.setItem('distributions', JSON.stringify(distributions));
            localStorage.setItem('baseGuards', JSON.stringify(baseGuards));
        } catch (error) {
            console.error("Error saving settings to local storage:", error);
            setStatusMessage("⚠️ حدث خطأ أثناء حفظ الإعدادات.", "error", 5000);
        }
    }

    function startAutoSave() {
        if (autoSaveTimer) {
            clearInterval(autoSaveTimer);
        }
        autoSaveTimer = setInterval(() => {
            if (allGuards.length > 0) {
                saveCurrentDistribution(); // Use saveCurrentDistribution to also update period distribution
                console.log("Auto-saved distribution.");
            }
        }, AUTO_SAVE_INTERVAL);
    }

    function initializePeriodSelect() {
        const periodSelect = document.getElementById(IDS.PERIOD_SELECT);
        periodSelect.innerHTML = '';
        for (let i = 1; i <= TOTAL_PERIODS; i++) {
            let option = document.createElement("option");
            option.value = i;
            option.textContent = `الفترة ${i}`;
            periodSelect.appendChild(option);
        }
        periodSelect.value = currentPeriod;
    }

    function attachEventListeners() {
        const excelFileInput = document.getElementById(IDS.EXCEL_FILE);
        if (excelFileInput) {
            excelFileInput.addEventListener("change", importExcel);
        } else {
            console.error("العنصر excelFile غير موجود في DOM.");
            setStatusMessage("⚠️ خطأ داخلي: عنصر إدخال ملف Excel مفقود.", "error");
        }
        
        document.getElementById(IDS.PERIOD_SELECT).addEventListener("change", changePeriod);
        document.getElementById(IDS.ROOM_COUNT).addEventListener("change", saveSettingsToLocalStorage);
        document.getElementById(IDS.GUARDS_PER_ROOM).addEventListener("change", saveSettingsToLocalStorage);

        document.getElementById(IDS.RANDOM_ASSIGN_BTN).addEventListener("click", assignRandomly);
        document.getElementById(IDS.SAVE_DISTRIBUTION_BTN).addEventListener("click", saveCurrentDistribution);
        document.getElementById(IDS.GENERATE_LIST_BTN).addEventListener("click", generateFinalList);
        document.getElementById(IDS.EXPORT_DISTRIBUTION_BTN).addEventListener("click", exportDistribution);
        
        const clearCacheBtn = document.getElementById(IDS.CLEAR_CACHE_BTN);
        if (clearCacheBtn) {
            clearCacheBtn.addEventListener("click", clearCacheAndLocalStorage);
        } else {
            console.error("العنصر clearCacheBtn غير موجود في DOM.");
        }

        // New event listener for Reset Distribution button
        const resetDistributionBtn = document.getElementById(IDS.RESET_DISTRIBUTION_BTN);
        if (resetDistributionBtn) {
            resetDistributionBtn.addEventListener("click", resetCurrentDistribution);
        } else {
            console.error("العنصر resetDistributionBtn غير موجود في DOM.");
        }

        // Event listeners for filter controls
        document.getElementById(IDS.SEARCH_GUARD_INPUT).addEventListener("input", applyFilters);
        document.getElementById(IDS.CLEAR_SEARCH_BTN).addEventListener("click", function() {
            document.getElementById(IDS.SEARCH_GUARD_INPUT).value = "";
            applyFilters();
        });
        document.getElementById(IDS.FILTER_RANK).addEventListener("change", applyFilters);
        document.getElementById(IDS.FILTER_SUBJECT).addEventListener("change", applyFilters);
        document.getElementById(IDS.FILTER_INSTITUTION).addEventListener("change", applyFilters);

        // Event listener for adding new guard manually
        document.getElementById(IDS.ADD_GUARD_BTN).addEventListener('click', addNewGuard);
    }

    function setStatusMessage(message, type = "info", duration = 3000) {
        const statusMessageDiv = document.getElementById(IDS.STATUS_MESSAGE);
        if (!statusMessageDiv) {
            console.error("العنصر statusMessage غير موجود في DOM.");
            return;
        }
        statusMessageDiv.textContent = message;
        statusMessageDiv.className = '';
        statusMessageDiv.classList.add(
            type === 'success' ? 'status-success' :
            type === 'error' ? 'status-error' :
            type === 'loading' ? 'status-loading' :
            'status-info'
        );
        statusMessageDiv.style.display = 'block';
        statusMessageDiv.style.opacity = '1';

        if (type !== 'loading') {
            setTimeout(() => {
                statusMessageDiv.style.opacity = '0';
                setTimeout(() => { statusMessageDiv.style.display = 'none'; }, 500);
            }, duration);
        }
    }

    async function importExcel(event) {
        setStatusMessage(MESSAGES.LOADING_IMPORT, "loading");
        if (!window.XLSX) {
            setStatusMessage(MESSAGES.SHEETJS_LOAD_ERROR, "error");
            return;
        }
        const file = event.target.files[0];
        if (!file) {
            setStatusMessage(MESSAGES.FILE_NOT_SELECTED, "error");
            return;
        }

        try {
            const data = await readFileAsync(file);
            const workbook = XLSX.read(data, { type: "array" });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const json = XLSX.utils.sheet_to_json(sheet);

            const requiredFields = ["الاسم واللقب", "المادة", "الرتبة", "المؤسسة"];
            const firstRow = json[0] || {};
            const missingFields = requiredFields.filter(field => !(field in firstRow));

            if (missingFields.length > 0) {
                setStatusMessage(MESSAGES.MISSING_FIELDS(missingFields), "error", 6000);
                return;
            }

            baseGuards = json.map(row => ({
                ...row,
                "القاعة": "",
                "رئيسي": false,
                "معفى": false,
                "احتياطي": false
            }));
            
            allGuards = JSON.parse(JSON.stringify(baseGuards));
            distributions = {}; // Clear distributions on new import
            currentPeriod = 1;
            document.getElementById(IDS.PERIOD_SELECT).value = currentPeriod;

            // Apply fixed guards from globalFixedAssignments to newly imported data
            allGuards.forEach(g => {
                if (globalFixedAssignments[g["الاسم واللقب"]]) {
                    g["القاعة"] = globalFixedAssignments[g["الاسم واللقب"]];
                    // Do not automatically set 'رئيسي' here when applying fixed assignments
                    g["معفى"] = false; // Fixed guards cannot be exempt or reserve
                    g["احتياطي"] = false;
                }
            });

            saveSettingsToLocalStorage();
            populateFilterOptions(); // Populate filter options after import
            applyFilters(); // Apply filters to update the displayed table
            setStatusMessage(MESSAGES.IMPORT_SUCCESS, "success");
            console.log('Excel imported successfully', allGuards);

        } catch (error) {
            console.error('Error importing Excel:', error);
            setStatusMessage(MESSAGES.EXCEL_READ_ERROR, "error", 6000);
        }
    }

    function readFileAsync(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(new Uint8Array(e.target.result));
            reader.onerror = (e) => reject(e);
            reader.readAsArrayBuffer(file);
        });
    }

    function changePeriod() {
        currentPeriod = parseInt(document.getElementById(IDS.PERIOD_SELECT).value);
        saveSettingsToLocalStorage();

        if (distributions[currentPeriod]) {
            allGuards = JSON.parse(JSON.stringify(distributions[currentPeriod]));
        } else {
            allGuards = JSON.parse(JSON.stringify(baseGuards));
        }

        // Re-apply fixed guards after loading period distribution
        allGuards.forEach(g => {
            if (globalFixedAssignments[g["الاسم واللقب"]]) {
                g["القاعة"] = globalFixedAssignments[g["الاسم واللقب"]];
                // Do not automatically set 'رئيسي' here when loading fixed guards
                if (g["معفى"]) {
                    g["معفى"] = false;
                    setStatusMessage(`تم إلغاء إعفاء الحارس ${g["الاسم واللقب"]} لأنه مثبت.`, "info", 5000);
                }
                if (g["احتياطي"]) {
                    g["احتياطي"] = false;
                    setStatusMessage(`تم إلغاء حالة احتياطي للحارس ${g["الاسم واللقب"]} لأنه مثبت.`, "info", 5000);
                }
            }
        });
        populateFilterOptions(); // Re-populate filter options for new period's data
        applyFilters(); // Re-apply filters to refresh the table
        setStatusMessage(MESSAGES.PERIOD_CHANGED(currentPeriod), "info");
    }

    function populateFilterOptions() {
        const ranks = new Set();
        const subjects = new Set();
        const institutions = new Set();

        baseGuards.forEach(g => {
            if (g["الرتبة"]) ranks.add(g["الرتبة"]);
            if (g["المادة"]) subjects.add(g["المادة"]);
            if (g["المؤسسة"]) institutions.add(g["المؤسسة"]);
        });

        const filterRank = document.getElementById(IDS.FILTER_RANK);
        const filterSubject = document.getElementById(IDS.FILTER_SUBJECT);
        const filterInstitution = document.getElementById(IDS.FILTER_INSTITUTION);

        function addOptions(selectElement, optionsSet) {
            const currentValue = selectElement.value; // Store current selected value
            selectElement.innerHTML = '<option value="">الكل</option>';
            Array.from(optionsSet).sort().forEach(option => {
                const opt = document.createElement("option");
                opt.value = option;
                opt.textContent = option;
                selectElement.appendChild(opt);
            });
            // Try to restore previous selection if it still exists
            if (Array.from(optionsSet).includes(currentValue) || currentValue === "") {
                selectElement.value = currentValue;
            } else {
                selectElement.value = ""; // Reset if current value is no longer valid
            }
        }

        addOptions(filterRank, ranks);
        addOptions(filterSubject, subjects);
        addOptions(filterInstitution, institutions);
    }

    function applyFilters() {
        const searchTerm = document.getElementById(IDS.SEARCH_GUARD_INPUT).value.toLowerCase();
        const selectedRank = document.getElementById(IDS.FILTER_RANK).value;
        const selectedSubject = document.getElementById(IDS.FILTER_SUBJECT).value;
        const selectedInstitution = document.getElementById(IDS.FILTER_INSTITUTION).value;

        const filteredGuards = allGuards.filter(g => {
            const matchesSearch = (g["الاسم واللقب"] || "").toLowerCase().includes(searchTerm) ||
                                  (g["المادة"] || "").toLowerCase().includes(searchTerm);
            const matchesRank = selectedRank === "" || g["الرتبة"] === selectedRank;
            const matchesSubject = selectedSubject === "" || g["المادة"] === selectedSubject;
            const matchesInstitution = selectedInstitution === "" || g["المؤسسة"] === selectedInstitution;

            return matchesSearch && matchesRank && matchesSubject && matchesInstitution;
        });

        updateGuardsTable(filteredGuards);
    }

    function assignRandomly() {
        setStatusMessage(MESSAGES.LOADING_ASSIGN, "loading");
        const roomCount = parseInt(document.getElementById(IDS.ROOM_COUNT).value);
        const guardsPerRoom = parseInt(document.getElementById(IDS.GUARDS_PER_ROOM).value);

        if (baseGuards.length === 0) {
            setStatusMessage("⚠️ يرجى استيراد ملف الحراس أولاً.", "error");
            return;
        }

        // Start with a clean slate for assignment for non-fixed, non-exempt, non-reserve guards
        let workingGuards = JSON.parse(JSON.stringify(allGuards)); // Deep copy for manipulation
        
        // Initialize room assignments structure
        const roomAssignments = {};
        for (let i = 1; i <= roomCount; i++) {
            roomAssignments[i] = [];
        }

        let nonAssignedGuards = [];
        let currentMainGuardsCount = 0; // Track assigned main guards

        // 1. Prioritize assigning FIXED guards first, maintaining their properties
        workingGuards.forEach(guard => {
            if (globalFixedAssignments[guard["الاسم واللقب"]]) {
                const fixedRoom = parseInt(globalFixedAssignments[guard["الاسم واللقب"]]);
                // Ensure room is valid and not yet full
                if (fixedRoom >= 1 && fixedRoom <= roomCount && roomAssignments[fixedRoom].length < guardsPerRoom) {
                    // Re-add to the room and retain its properties (القاعة, رئيسي)
                    roomAssignments[fixedRoom].push(guard);
                    if (guard["رئيسي"]) { // Count only if it was already marked as main
                        currentMainGuardsCount++;
                    }
                } else {
                    // If fixed guard's room is invalid or full, treat as unassigned for now
                    nonAssignedGuards.push(guard);
                }
            } else if (!guard["معفى"] && !guard["احتياطي"]) {
                // For non-fixed, non-exempt, non-reserve guards, clear their assignment for random distribution
                guard["القاعة"] = "";
                guard["رئيسي"] = false;
                nonAssignedGuards.push(guard);
            } else {
                // Exempt and reserve guards are already excluded from assignment logic
                // If they were somehow assigned, clear their room/main status
                guard["القاعة"] = "";
                guard["رئيسي"] = false;
            }
        });

        shuffleArray(nonAssignedGuards); // Shuffle only the truly assignable guards

        // 2. Fill remaining main guard slots from nonAssignedGuards, prioritizing different institutions
        for (let room = 1; room <= roomCount; room++) {
            const hasMainGuard = roomAssignments[room].some(g => g["رئيسي"]);
            if (!hasMainGuard && roomAssignments[room].length < guardsPerRoom) {
                if (currentMainGuardsCount < roomCount) {
                    let chosenGuardIndex = -1;
                    const institutionsInRoom = new Set(roomAssignments[room].map(g => g["المؤسسة"]));

                    // Try to find a main guard from a different institution among nonAssignedGuards
                    chosenGuardIndex = nonAssignedGuards.findIndex(g => !institutionsInRoom.has(g["المؤسسة"]));

                    // If no main guard from different institution, take the first available nonAssignedGuard
                    if (chosenGuardIndex === -1 && nonAssignedGuards.length > 0) {
                        chosenGuardIndex = 0;
                    }

                    if (chosenGuardIndex !== -1) {
                        const mainGuard = nonAssignedGuards.splice(chosenGuardIndex, 1)[0];
                        mainGuard["القاعة"] = room.toString();
                        mainGuard["رئيسي"] = true; // Mark as main
                        roomAssignments[room].push(mainGuard);
                        currentMainGuardsCount++;
                    }
                }
            }
        }
        
        if (currentMainGuardsCount < roomCount) {
             setStatusMessage(MESSAGES.NOT_ENOUGH_MAIN_GUARDS(currentMainGuardsCount, roomCount), "info", 8000);
        }

        // 3. Fill remaining slots from nonAssignedGuards, prioritizing different institutions
        for (let room = 1; room <= roomCount; room++) {
            while (roomAssignments[room].length < guardsPerRoom && nonAssignedGuards.length > 0) {
                let chosenGuardIndex = -1;
                const institutionsInRoom = new Set(roomAssignments[room].map(g => g["المؤسسة"]));

                // Try to find a guard from a different institution among nonAssignedGuards
                chosenGuardIndex = nonAssignedGuards.findIndex(g => !institutionsInRoom.has(g["المؤسسة"]));
                
                // If no guard from different institution, take the first available nonAssignedGuard
                if (chosenGuardIndex === -1 && nonAssignedGuards.length > 0) {
                    chosenGuardIndex = 0;
                }

                if (chosenGuardIndex !== -1) {
                    const guardToAssign = nonAssignedGuards.splice(chosenGuardIndex, 1)[0];
                    guardToAssign["القاعة"] = room.toString();
                    guardToAssign["رئيسي"] = false; // Ensure they are not main unless explicitly set
                    roomAssignments[room].push(guardToAssign);
                }
            }
        }

        // 4. Update allGuards with the new assignments and manage reserves/exempts
        const assignedNames = new Set();
        Object.values(roomAssignments).forEach(roomGuards => {
            roomGuards.forEach(guard => {
                // Find the original guard object in allGuards and update its properties
                const originalGuard = allGuards.find(g => g["الاسم واللقب"] === guard["الاسم واللقب"]);
                if (originalGuard) {
                    originalGuard["القاعة"] = guard["القاعة"];
                    originalGuard["رئيسي"] = guard["رئيسي"];
                    originalGuard["احتياطي"] = false; // If assigned, cannot be reserve
                    assignedNames.add(guard["الاسم واللقب"]);
                }
            });
        });

        // Any guard in `allGuards` that wasn't assigned (and isn't fixed, exempt, or explicitly reserve)
        // should become a reserve. Fixed guards remain as they are.
        allGuards.forEach(guard => {
            if (!assignedNames.has(guard["الاسم واللقب"]) && !globalFixedAssignments[guard["الاسم واللقب"]] && !guard["معفى"]) {
                guard["احتياطي"] = true;
                guard["القاعة"] = "";
                guard["رئيسي"] = false;
            } else if (!assignedNames.has(guard["الاسم واللقب"]) && globalFixedAssignments[guard["الاسم واللقب"]]) {
                 // If a fixed guard's room was invalid/full and thus not assigned, they remain as fixed
                 // in their originally specified room in globalFixedAssignments for the next load/manipulation.
                 // They should not become reserve.
                 guard["احتياطي"] = false; // Ensure they are not marked as reserve if fixed
                 guard["القاعة"] = globalFixedAssignments[guard["الاسم واللقب"]]; // Keep their fixed room
                 // If fixed and not assigned, they will simply not appear in the final list for this distribution.
            }
        });
        
        const unfilledRooms = Object.entries(roomAssignments)
            .filter(([, guards]) => guards.length < guardsPerRoom)
            .map(([room, guards]) => `القاعة ${room} (عدد الحراس: ${guards.length}/${guardsPerRoom})`)
            .join("\n");

        if (unfilledRooms.length > 0) {
            setStatusMessage(MESSAGES.UNFILLED_ROOMS(unfilledRooms), "info", 8000);
        } else {
             setStatusMessage(MESSAGES.RANDOM_ASSIGN_SUCCESS, "success");
        }
        
        applyFilters(); // Use applyFilters to update table after assignment
        saveCurrentDistribution();
    }

    function updateGuardsTable(guardsToDisplay = allGuards) {
        const tbody = document.querySelector(`#${IDS.GUARDS_TABLE} tbody`);
        if (!tbody) {
            console.error("العنصر guardsTable tbody غير موجود في DOM.");
            return;
        }
        
        const fragment = document.createDocumentFragment();

        guardsToDisplay.forEach((g_filtered, i_filtered) => {
            const originalIndex = allGuards.findIndex(guard => guard["الاسم واللقب"] === g_filtered["الاسم واللقب"]);
            
            if (originalIndex === -1) {
                console.warn(`Guard ${g_filtered["الاسم واللقب"]} not found in allGuards during display update.`);
                return;
            }

            const g = allGuards[originalIndex];
            const isFixed = !!globalFixedAssignments[g["الاسم واللقب"]];

            const row = document.createElement("tr");

            if (g["معفى"]) {
                row.classList.add("exempt-guard-row");
            } else if (g["احتياطي"]) {
                row.classList.add("reserve-guard-row");
            } else if (isFixed) { // Check for fixed status using the new variable
                row.classList.add("fixed-guard-row");
            } else if (g["رئيسي"]) {
                row.classList.add("main-guard-row");
            }

            const numCell = document.createElement("td");
            numCell.textContent = i_filtered + 1; 
            row.appendChild(numCell);

            const fields = ["الاسم واللقب", "المادة", "الرتبة", "المؤسسة"];
            fields.forEach(field => {
                const cell = document.createElement("td");
                cell.textContent = g[field] || "";
                row.appendChild(cell);
            });

            const roomCell = document.createElement("td");
            const roomInput = document.createElement("input");
            roomInput.type = "text";
            roomInput.value = g["القاعة"] || "";
            // Room input is disabled only if exempt or reserve, but NOT if fixed.
            roomInput.disabled = g["معفى"] || g["احتياطي"];
            roomInput.addEventListener("change", function() {
                const value = this.value.trim();
                // If it's a fixed guard and room changed, update the fixed assignment
                if (isFixed && value && /^\d+$/.test(value)) {
                    globalFixedAssignments[g["الاسم واللقب"]] = value;
                } else if (isFixed && !value) {
                     // If fixed guard removes room, also remove from fixed assignments
                    delete globalFixedAssignments[g["الاسم واللقب"]];
                }

                if (value && !/^\d+$/.test(value)) {
                    setStatusMessage(MESSAGES.ROOM_INPUT_ERROR, "error");
                    this.value = allGuards[originalIndex]["القاعة"] || "";
                    return;
                }
                allGuards[originalIndex]["القاعة"] = value;
                saveCurrentDistribution();
                applyFilters(); // Re-apply filters to update visual classification
            });
            roomCell.appendChild(roomInput);
            row.appendChild(roomCell);

            const mainCell = document.createElement("td");
            const mainCheckbox = document.createElement("input");
            mainCheckbox.type = "checkbox";
            mainCheckbox.checked = g["رئيسي"];
            // Main checkbox is disabled only if exempt or reserve
            mainCheckbox.disabled = g["معفى"] || g["احتياطي"];

            mainCheckbox.addEventListener("change", function() {
                const roomCount = parseInt(document.getElementById(IDS.ROOM_COUNT).value);
                const targetRoom = allGuards[originalIndex]["القاعة"];

                if (this.checked) {
                    if (!targetRoom) {
                        setStatusMessage(MESSAGES.MAIN_ROOM_REQUIRED, "error", 5000);
                        this.checked = false;
                        return;
                    }
                    
                    const mainGuardInTargetRoom = allGuards.some((guard, idx) => 
                        idx !== originalIndex && guard["القاعة"] === targetRoom && guard["رئيسي"] && !guard["معفى"]
                    );

                    if (mainGuardInTargetRoom) {
                        setStatusMessage(MESSAGES.TOO_MANY_MAIN_GUARDS_IN_ROOM(targetRoom), "error", 7000);
                        this.checked = false;
                        return;
                    }
                    
                    const currentMainGuardsGlobal = allGuards.filter(guard => 
                        guard["رئيسي"] && !guard["معفى"] && guard["الاسم واللقب"] !== g["الاسم واللقب"]
                    ).length;

                    if (currentMainGuardsGlobal + 1 > roomCount) {
                        setStatusMessage(MESSAGES.TOO_MANY_MAIN_GUARDS_MANUAL(roomCount), "error", 5000);
                        this.checked = false;
                        return;
                    }
                }
                
                allGuards[originalIndex]["رئيسي"] = this.checked;
                saveCurrentDistribution();
                applyFilters(); // Re-apply filters to update visual classification
            });
            mainCell.appendChild(mainCheckbox);
            row.appendChild(mainCell);

            const fixCell = document.createElement("td");
            const fixCheckbox = document.createElement("input");
            fixCheckbox.type = "checkbox";
            fixCheckbox.checked = isFixed; // Use the isFixed flag
            // Fixed checkbox is disabled only if exempt or reserve
            fixCheckbox.disabled = g["معفى"] || g["احتياطي"];
            fixCheckbox.addEventListener("change", function() {
                if (this.checked) {
                    if (!allGuards[originalIndex]["القاعة"]) {
                        setStatusMessage(MESSAGES.FIX_ROOM_REQUIRED, "error");
                        this.checked = false;
                        return;
                    }
                    // When a guard is fixed, they cannot be exempt or reserve
                    if (allGuards[originalIndex]["معفى"]) {
                        allGuards[originalIndex]["معفى"] = false;
                        setStatusMessage(`تم إلغاء إعفاء الحارس ${g["الاسم واللقب"]} لأنه مثبت.`, "info", 5000);
                    }
                    if (allGuards[originalIndex]["احتياطي"]) {
                        allGuards[originalIndex]["احتياطي"] = false;
                        setStatusMessage(`تم إلغاء حالة احتياطي للحارس ${g["الاسم واللقب"]} لأنه مثبت.`, "info", 5000);
                    }

                    globalFixedAssignments[g["الاسم واللقب"]] = allGuards[originalIndex]["القاعة"];
                    // DO NOT automatically set 'رئيسي' here
                } else {
                    delete globalFixedAssignments[g["الاسم واللقب"]];
                    // DO NOT automatically set 'رئيسي' to false here
                }
                saveSettingsToLocalStorage(); // Save the fixed assignments
                applyFilters(); // Re-apply filters to update visual classification
                saveCurrentDistribution(); // Save the current distribution which might include changes due to fixed status
            });
            fixCell.appendChild(fixCheckbox);
            row.appendChild(fixCell);

            const exemptCell = document.createElement("td");
            const exemptCheckbox = document.createElement("input");
            exemptCheckbox.type = "checkbox";
            exemptCheckbox.checked = g["معفى"];
            // Exempt checkbox is disabled if fixed or reserve
            exemptCheckbox.disabled = isFixed || g["احتياطي"]; 
            exemptCheckbox.addEventListener("change", function() {
                allGuards[originalIndex]["معفى"] = this.checked;
                if (this.checked) {
                    // If exempt, remove from fixed and set room/main/reserve to false
                    if (isFixed) {
                        delete globalFixedAssignments[g["الاسم واللقب"]];
                        saveSettingsToLocalStorage();
                    }
                    allGuards[originalIndex]["القاعة"] = "";
                    allGuards[originalIndex]["رئيسي"] = false;
                    allGuards[originalIndex]["احتياطي"] = false;
                    setStatusMessage(`✅ تم جعل الحارس ${g["الاسم واللقب"]} معفى.`, "success");
                } else {
                     setStatusMessage(`✅ تم إلغاء حالة الإعفاء للحارس ${g["الاسم واللقب"]}.`, "info");
                }
                applyFilters(); // Re-apply filters to update visual classification
                saveCurrentDistribution();
            });
            exemptCell.appendChild(exemptCheckbox);
            row.appendChild(exemptCell);

            const reserveCell = document.createElement("td");
            reserveCell.classList.add("reserve-select-cell");

            const reserveSelect = document.createElement("select");
            reserveSelect.className = "reserve-select";

            const optionNo = document.createElement("option");
            optionNo.value = "false";
            optionNo.textContent = "غير احتياطي";
            reserveSelect.appendChild(optionNo);

            const optionYes = document.createElement("option");
            optionYes.value = "true";
            optionYes.textContent = "احتياطي";
            reserveSelect.appendChild(optionYes);

            reserveSelect.value = g["احتياطي"] ? "true" : "false";
            // Reserve select is disabled if fixed or exempt
            reserveSelect.disabled = isFixed || g["معفى"];
            reserveSelect.addEventListener("change", function() {
                const isReserve = this.value === "true";
                allGuards[originalIndex]["احتياطي"] = isReserve;

                if (isReserve) {
                    allGuards[originalIndex]["القاعة"] = "";
                    allGuards[originalIndex]["رئيسي"] = false;
                    // If reserve, remove from fixed and exempt
                    if (isFixed) {
                        delete globalFixedAssignments[g["الاسم واللقب"]];
                        saveSettingsToLocalStorage();
                    }
                    allGuards[originalIndex]["معفى"] = false;
                    setStatusMessage(MESSAGES.RESERVE_GUARD_ENABLED(g["الاسم واللقب"]), "success");
                } else {
                    setStatusMessage(MESSAGES.RESERVE_GUARD_DISABLED(g["الاسم واللقب"]), "info");
                }
                applyFilters(); // Re-apply filters to update visual classification
                saveCurrentDistribution();
            });
            reserveCell.appendChild(reserveSelect);
            row.appendChild(reserveCell);

            const deleteCell = document.createElement("td");
            const deleteButton = document.createElement("button");
            deleteButton.className = "btn-danger";
            deleteButton.textContent = "🗑️";
            // Allow deletion only if not fixed, not exempt, and not reserve
            deleteButton.disabled = isFixed || g["معفى"] || g["احتياطي"];
            deleteButton.addEventListener("click", () => {
                if (confirm(MESSAGES.GUARD_DELETED(g["الاسم واللقب"]) + " هل أنت متأكد من الحذف؟")) {
                    deleteGuard(originalIndex);
                }
            });
            deleteCell.appendChild(deleteButton);
            row.appendChild(deleteCell);

            fragment.appendChild(row);
        });

        tbody.innerHTML = "";
        tbody.appendChild(fragment);
    }

    function deleteGuard(index) {
        const guardName = allGuards[index]["الاسم واللقب"];
        
        allGuards.splice(index, 1);

        baseGuards = baseGuards.filter(g => g["الاسم واللقب"] !== guardName);

        for (const period in distributions) {
            if (distributions.hasOwnProperty(period)) {
                distributions[period] = distributions[period].filter(g => g["الاسم واللقب"] !== guardName);
            }
        }
        
        // Updated to use the new variable name
        delete globalFixedAssignments[guardName]; 
        
        saveSettingsToLocalStorage();
        populateFilterOptions(); // Update filter options after deleting a guard
        applyFilters(); // Re-apply filters to update the displayed table
        setStatusMessage(MESSAGES.GUARD_DELETED(guardName), "success");
    }

    // New Function: Reset Current Distribution
    function resetCurrentDistribution() {
        if (confirm(MESSAGES.RESET_DISTRIBUTION_CONFIRM)) {
            // Revert allGuards to the state of baseGuards, but clear distribution specific properties
            allGuards = JSON.parse(JSON.stringify(baseGuards)); // Deep copy to ensure independence
            allGuards.forEach(guard => {
                // Keep fixed guard properties, reset others
                // Updated to use the new variable name
                if (globalFixedAssignments[guard["الاسم واللقب"]]) {
                    guard["القاعة"] = globalFixedAssignments[guard["الاسم واللقب"]];
                    // Do not reset 'رئيسي' for fixed guards here. Let it retain its state if set manually.
                    guard["معفى"] = false;
                    guard["احتياطي"] = false;
                } else {
                    guard["القاعة"] = "";
                    guard["رئيسي"] = false;
                    guard["معفى"] = false;
                    guard["احتياطي"] = false;
                }
            });

            // Remove the current period's distribution from `distributions` if it exists
            if (distributions[currentPeriod]) {
                delete distributions[currentPeriod];
            }

            updateGuardsTable();
            generateFinalList(); // Clear final lists display and regenerate if needed
            saveCurrentDistribution(); // Save this cleared state
            setStatusMessage(MESSAGES.RESET_DISTRIBUTION_SUCCESS, 'success');
        }
    }


    function saveCurrentDistribution() {
        distributions[currentPeriod] = JSON.parse(JSON.stringify(allGuards));
        saveSettingsToLocalStorage();
        setStatusMessage(MESSAGES.SAVE_SUCCESS(currentPeriod), "success");
    }

    function generateFinalList() {
        const finalTable = document.getElementById(IDS.FINAL_GUARDS_TABLE);
        const reserveTable = document.getElementById(IDS.RESERVE_GUARDS_TABLE);
        if (!finalTable || !reserveTable) {
            console.error("أحد جداول القائمة النهائية/الاحتياطية مفقود في DOM.");
            setStatusMessage("⚠️ لا يمكن طباعة القائمة. الجداول غير موجودة.", "error");
            return;
        }

        const assignedGuards = allGuards.filter(g => g["القاعة"] && !g["معفى"] && !g["احتياطي"]);
        const reserveGuards = allGuards.filter(g => g["احتياطي"]);

        reserveGuards.sort((a, b) => a["الاسم واللقب"].localeCompare(b["الاسم واللقب"]));

        assignedGuards.sort((a, b) => {
            const roomA = parseInt(a["القاعة"]);
            const roomB = parseInt(b["القاعة"]);
            if (roomA !== roomB) return roomA - roomB;
            return (b["رئيسي"] ? -1 : 0) - (a["رئيسي"] ? -1 : 0); // Main guards first within a room
        });

        const groupedByRoom = assignedGuards.reduce((acc, guard) => {
            const room = guard["القاعة"];
            if (!acc[room]) {
                acc[room] = [];
            }
            acc[room].push(guard);
            return acc;
        }, {});

        let finalTableHtml = `<thead><tr><th>القاعة</th><th>الحارس الرئيسي</th>`;
        const guardsPerRoom = parseInt(document.getElementById(IDS.GUARDS_PER_ROOM).value);
        for(let i = 2; i <= guardsPerRoom; i++) {
            finalTableHtml += `<th>الحارس ${i}</th>`;
        }
        finalTableHtml += `</tr></thead><tbody>`;

        const sortedRooms = Object.keys(groupedByRoom).sort((a, b) => parseInt(a) - parseInt(b));

        sortedRooms.forEach(room => {
            const guardsInRoom = groupedByRoom[room];
            finalTableHtml += `<tr><td>${room}</td>`;
            for (let i = 0; i < guardsPerRoom; i++) {
                finalTableHtml += `<td>${guardsInRoom[i]?.["الاسم واللقب"] || ""}</td>`;
            }
            finalTableHtml += `</tr>`;
        });
        finalTableHtml += `</tbody>`;
        finalTable.innerHTML = finalTableHtml;

        let reserveTableHtml = `<thead><tr><th>الرقم</th><th>الاسم</th><th>المادة</th><th>الرتبة</th><th>المؤسسة</th></tr></thead><tbody>`;
        reserveGuards.forEach((g, index) => {
            reserveTableHtml += `<tr><td>${index + 1}</td><td>${g["الاسم واللقب"]}</td><td>${g["المادة"]}</td><td>${g["الرتبة"]}</td><td>${g["المؤسسة"]}</td></tr>`;
        });
        reserveTableHtml += `</tbody>`;
        reserveTable.innerHTML = reserveTableHtml;

        document.getElementById(IDS.PRINT_BTN).style.display = "block";
        setStatusMessage(MESSAGES.GENERATE_LIST_SUCCESS, "success");
    }

    function exportDistribution() {
        setStatusMessage(MESSAGES.LOADING_EXPORT, "loading");
        if (!window.XLSX) {
            setStatusMessage(MESSAGES.SHEETJS_LOAD_ERROR, "error");
            return;
        }

        const assignedGuards = allGuards.filter(g => g["القاعة"] && !g["معفى"] && !g["احتياطي"]);
        const reserveGuards = allGuards.filter(g => g["احتياطي"]);
        
        reserveGuards.sort((a, b) => a["الاسم واللقب"].localeCompare(b["الاسم واللقب"]));

        assignedGuards.sort((a, b) => {
            const roomA = parseInt(a["القاعة"]);
            const roomB = parseInt(b["القاعة"]);
            if (roomA !== roomB) return roomA - roomB;
            return (b["رئيسي"] ? -1 : 0) - (a["رئيسي"] ? -1 : 0);
        });

        const groupedByRoomForExport = assignedGuards.reduce((acc, guard) => {
            const room = guard["القاعة"];
            if (!acc[room]) {
                acc[room] = [];
            }
            acc[room].push(guard["الاسم واللقب"]);
            return acc;
        }, {});

        const guardsPerRoom = parseInt(document.getElementById(IDS.GUARDS_PER_ROOM).value);
        let headerRow = ["القاعة", "الحارس الرئيسي"];
        for(let i = 2; i <= guardsPerRoom; i++) {
            headerRow.push(`الحارس ${i}`);
        }

        const wsData = [
            ["قائمة الحراسة النهائية - الفترة " + currentPeriod],
            [],
            headerRow,
            ...Object.entries(groupedByRoomForExport).sort(([rA], [rB]) => parseInt(rA) - parseInt(rB))
                .map(([room, guards]) => {
                    let row = [room];
                    for(let i = 0; i < guardsPerRoom; i++) {
                        row.push(guards[i] || "");
                    }
                    return row;
                }),
            [],
            ["الحراس الاحتياطيون"],
            ["الاسم", "المادة", "الرتبة", "المؤسسة"],
            ...reserveGuards.map(g => [g["الاسم واللقب"], g["المادة"], g["الرتبة"], g["المؤسسة"]])
        ];

        const ws = XLSX.utils.aoa_to_sheet(wsData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "توزيع الحراسة");
        XLSX.writeFile(wb, `توزيع_الحراسة_الفترة_${currentPeriod}.xlsx`);
        setStatusMessage(MESSAGES.EXPORT_SUCCESS, "success");
    }

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    function printTable() {
        setStatusMessage(MESSAGES.LOADING_PRINT, "loading");
        const finalTable = document.getElementById(IDS.FINAL_GUARDS_TABLE);
        const reserveTable = document.getElementById(IDS.RESERVE_GUARDS_TABLE);

        if (!finalTable || !reserveTable) {
            setStatusMessage("⚠️ لا يمكن طباعة القائمة. الجداول غير موجودة.", "error");
            return;
        }

        const finalTableHtml = finalTable.outerHTML;
        const reserveTableHtml = reserveTable.outerHTML;

        const printWindow = window.open("", "_blank", "width=900,height=700,scrollbars=yes");
        if (!printWindow) {
            setStatusMessage("⚠️ لا يمكن فتح نافذة الطباعة. قد تكون النوافذ المنبثقة محظورة.", "error");
            return;
        }

        printWindow.document.write(`
            <!DOCTYPE html>
            <html lang="ar" dir="rtl">
            <head>
                <meta charset="UTF-8">
                <title>طباعة قائمة الحراسة</title>
                <style>
                    html, body {
                        width: 100%;
                        margin: 0;
                        padding: 0;
                    }
                    body { 
                        font-family: 'Arial', sans-serif; 
                        margin: 1cm; /* Adjust overall padding for print */
                        color: black;
                        font-size: 11pt; /* Slightly smaller base font for more content */
                        direction: rtl; /* Ensure RTL for print */
                    }
                    h2, h3 { 
                        text-align: center; 
                        color: #333; 
                        margin-bottom: 10px; 
                        margin-top: 20px;
                        font-size: 16pt; /* Slightly smaller heading for print */
                        page-break-after: avoid; /* Keep heading with table below */
                    }
                    table { 
                        width: 100%; 
                        border-collapse: collapse; 
                        margin-bottom: 20px; /* Space between tables */
                        border: 1px solid #aaa; /* Clearer table borders */
                        page-break-inside: auto; /* Allow table to break across pages if necessary */
                    }
                    th, td { 
                        border: 1px solid #ccc; 
                        padding: 6px 8px; /* Reduced padding for more content */
                        text-align: right; 
                        font-size: 9pt; /* Smaller font for table cells */
                    }
                    th { 
                        background-color: #e0e0e0; /* Light background for headers */
                        color: #333;
                        font-weight: bold;
                    }
                    tr {
                        page-break-inside: avoid; /* Keep table rows together */
                        page-break-after: auto; /* Allow natural break after row */
                    }
                    thead { display: table-header-group; } /* Repeat headers on new pages */
                    tfoot { display: table-footer-group; } /* Repeat footers on new pages */
                </style>
            </head>
            <body>
                <h2>قائمة الحراسة النهائية - الفترة ${currentPeriod}</h2>
                ${finalTableHtml}
                <h3>الحراس الاحتياطيون</h3>
                ${reserveTableHtml}
            </body>
            </html>
        `);
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
        setStatusMessage(MESSAGES.PRINT_OPEN, "success");
    }

    function clearCacheAndLocalStorage() {
        if (confirm(MESSAGES.CLEAR_CACHE_CONFIRM)) {
            localStorage.clear();
            allGuards = [];
            baseGuards = [];
            distributions = {};
            currentPeriod = 1;
            // Updated to use the new variable name
            globalFixedAssignments = {}; 
            
            document.getElementById(IDS.ROOM_COUNT).value = 5;
            document.getElementById(IDS.GUARDS_PER_ROOM).value = 3;
            initializePeriodSelect();

            document.getElementById(IDS.FINAL_GUARDS_TABLE).innerHTML = '';
            document.getElementById(IDS.RESERVE_GUARDS_TABLE).innerHTML = '';
            document.getElementById(IDS.PRINT_BTN).style.display = "none";
            
            // Clear filter inputs as well
            document.getElementById(IDS.SEARCH_GUARD_INPUT).value = "";
            document.getElementById(IDS.FILTER_RANK).value = "";
            document.getElementById(IDS.FILTER_SUBJECT).value = "";
            document.getElementById(IDS.FILTER_INSTITUTION).value = "";

            updateGuardsTable();
            populateFilterOptions(); // Re-populate filter options after clearing
            
            setStatusMessage(MESSAGES.CLEAR_CACHE_SUCCESS, "success");
            
            if (autoSaveTimer) {
                clearInterval(autoSaveTimer);
                autoSaveTimer = null;
            }
        }
    }

    // Function to add a new guard manually
    function addNewGuard() {
        const name = document.getElementById(IDS.NEW_GUARD_NAME).value.trim();
        const subject = document.getElementById(IDS.NEW_GUARD_SUBJECT).value.trim();
        const rank = document.getElementById(IDS.NEW_GUARD_RANK).value.trim();
        const institution = document.getElementById(IDS.NEW_GUARD_INSTITUTION).value.trim();

        if (!name || !subject) {
            setStatusMessage(MESSAGES.ADD_GUARD_ERROR, 'error');
            return;
        }

        const newGuard = {
            "الاسم واللقب": name,
            "المادة": subject,
            "الرتبة": rank,
            "المؤسسة": institution,
            "القاعة": "",
            "رئيسي": false,
            "معفى": false,
            "احتياطي": false
        };

        allGuards.push(newGuard);
        baseGuards.push(newGuard); // Also add to baseGuards for reset purposes
        updateGuardsTable(); // Refresh the table
        saveCurrentDistribution(); // Save the updated list of guards
        setStatusMessage(MESSAGES.ADD_GUARD_SUCCESS, 'success');

        // Clear input fields
        document.getElementById(IDS.NEW_GUARD_NAME).value = '';
        document.getElementById(IDS.NEW_GUARD_SUBJECT).value = '';
        document.getElementById(IDS.NEW_GUARD_RANK).value = '';
        document.getElementById(IDS.NEW_GUARD_INSTITUTION).value = '';
        populateFilterOptions(); // Update filter options after adding a new guard
    }
</script>

</body>
</html>